# SPDX-FileCopyrightText: 2024 The Crossplane Authors <https://crossplane.io>
#
# SPDX-License-Identifier: Apache-2.0

# This example demonstrates how to create an Amazon Managed Service for Prometheus (AMP) Scraper
# that collects metrics from an Amazon EKS cluster with all required dependencies
# using the monolithic API (amp.aws.m.upbound.io).

apiVersion: amp.aws.m.upbound.io/v1beta1
kind: Workspace
metadata:
  annotations:
    meta.upbound.io/example-id: amp/v1beta1/scraper
    uptest.upbound.io/timeout: "7200"
  labels:
    testing.upbound.io/example-name: scraper-monolithic-demo
  name: scraper-monolithic-demo
spec:
  forProvider:
    region: us-east-1
---
apiVersion: amp.aws.m.upbound.io/v1beta1
kind: Scraper
metadata:
  annotations:
    meta.upbound.io/example-id: amp/v1beta1/scraper
    uptest.upbound.io/timeout: "7200"
  labels:
    testing.upbound.io/example-name: scraper-monolithic-demo
  name: scraper-monolithic-demo
spec:
  forProvider:
    region: us-east-1
    destination:
    - amp:
      - workspaceArnSelector:
          matchLabels:
            testing.upbound.io/example-name: scraper-monolithic-demo
    source:
    - eks:
      - clusterArnSelector:
          matchLabels:
            testing.upbound.io/example-name: scraper-monolithic-demo
        subnetIdsRefs:
        - name: subnet-1
        - name: subnet-2
        securityGroupIdsRefs:
        - name: scraper-sg
    scrapeConfiguration: |
      global:
        scrape_interval: 30s
      scrape_configs:
        # Scrape pod metrics
        - job_name: pod_exporter
          kubernetes_sd_configs:
            - role: pod
        # Scrape container metrics via cAdvisor
        - job_name: cadvisor
          scheme: https
          authorization:
            credentials_file: /var/run/secrets/kubernetes.io/serviceaccount/token
          kubernetes_sd_configs:
            - role: node
          relabel_configs:
            - action: labelmap
              regex: __meta_kubernetes_node_label_(.+)
            - replacement: kubernetes.default.svc:443
              target_label: __address__
            - source_labels: [__meta_kubernetes_node_name]
              regex: (.+)
              target_label: __metrics_path__
              replacement: /api/v1/nodes/$1/proxy/metrics/cadvisor
        # Scrape Kubernetes API server metrics
        - bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
          job_name: kubernetes-apiservers
          kubernetes_sd_configs:
          - role: endpoints
          relabel_configs:
          - action: keep
            regex: default;kubernetes;https
            source_labels:
            - __meta_kubernetes_namespace
            - __meta_kubernetes_service_name
            - __meta_kubernetes_endpoint_port_name
          scheme: https
        # Scrape kube-proxy metrics
        - job_name: kube-proxy
          honor_labels: true
          kubernetes_sd_configs:
          - role: pod
          relabel_configs:
          - action: keep
            source_labels:
            - __meta_kubernetes_namespace
            - __meta_kubernetes_pod_name
            separator: '/'
            regex: 'kube-system/kube-proxy.+'
          - source_labels:
            - __address__
            action: replace
            target_label: __address__
            regex: (.+?)(\\:\\d+)?
            replacement: $1:10249
---
apiVersion: iam.aws.m.upbound.io/v1beta1
kind: Role
metadata:
  annotations:
    meta.upbound.io/example-id: amp/v1beta1/scraper
  labels:
    testing.upbound.io/example-name: scraper-monolithic-demo-cluster
  name: scraper-monolithic-demo-cluster
spec:
  forProvider:
    assumeRolePolicy: |
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Principal": {
              "Service": "eks.amazonaws.com"
            },
            "Action": "sts:AssumeRole"
          }
        ]
      }
---
apiVersion: iam.aws.m.upbound.io/v1beta1
kind: RolePolicyAttachment
metadata:
  annotations:
    meta.upbound.io/example-id: amp/v1beta1/scraper
  labels:
    testing.upbound.io/example-name: scraper-monolithic-demo-cluster-policy
  name: scraper-monolithic-demo-cluster-policy
spec:
  forProvider:
    policyArn: arn:aws:iam::aws:policy/AmazonEKSClusterPolicy
    roleSelector:
      matchLabels:
        testing.upbound.io/example-name: scraper-monolithic-demo-cluster
---
apiVersion: eks.aws.m.upbound.io/v1beta1
kind: Cluster
metadata:
  annotations:
    meta.upbound.io/example-id: amp/v1beta1/scraper
    uptest.upbound.io/timeout: "7200"
  labels:
    testing.upbound.io/example-name: scraper-monolithic-demo
  name: scraper-monolithic-demo
spec:
  forProvider:
    region: us-east-1
    roleArnSelector:
      matchLabels:
        testing.upbound.io/example-name: scraper-monolithic-demo-cluster
    vpcConfig:
      - subnetIdRefs:
        - name: subnet-1
        - name: subnet-2
---
apiVersion: ec2.aws.m.upbound.io/v1beta1
kind: VPC
metadata:
  annotations:
    meta.upbound.io/example-id: amp/v1beta1/scraper
  labels:
    testing.upbound.io/example-name: scraper-monolithic-demo
  name: scraper-monolithic-demo
spec:
  forProvider:
    cidrBlock: 10.0.0.0/16
    enableDnsHostnames: true
    enableDnsSupport: true
    region: us-east-1
    tags:
      Name: scraper-monolithic-demo-vpc
---
apiVersion: ec2.aws.m.upbound.io/v1beta1
kind: Subnet
metadata:
  annotations:
    meta.upbound.io/example-id: amp/v1beta1/scraper
  labels:
    testing.upbound.io/example-name: scraper-monolithic-demo
  name: subnet-1
spec:
  forProvider:
    availabilityZone: us-east-1a
    cidrBlock: 10.0.1.0/24
    region: us-east-1
    vpcIdSelector:
      matchLabels:
        testing.upbound.io/example-name: scraper-monolithic-demo
    tags:
      Name: scraper-monolithic-demo-subnet-1
---
apiVersion: ec2.aws.m.upbound.io/v1beta1
kind: Subnet
metadata:
  annotations:
    meta.upbound.io/example-id: amp/v1beta1/scraper
  labels:
    testing.upbound.io/example-name: scraper-monolithic-demo
  name: subnet-2
spec:
  forProvider:
    availabilityZone: us-east-1b
    cidrBlock: 10.0.2.0/24
    region: us-east-1
    vpcIdSelector:
      matchLabels:
        testing.upbound.io/example-name: scraper-monolithic-demo
    tags:
      Name: scraper-monolithic-demo-subnet-2
---
apiVersion: ec2.aws.m.upbound.io/v1beta1
kind: SecurityGroup
metadata:
  annotations:
    meta.upbound.io/example-id: amp/v1beta1/scraper
  labels:
    testing.upbound.io/example-name: scraper-monolithic-demo
  name: scraper-sg
spec:
  forProvider:
    description: Security group for AMP scraper
    region: us-east-1
    vpcIdSelector:
      matchLabels:
        testing.upbound.io/example-name: scraper-monolithic-demo
    tags:
      Name: scraper-monolithic-demo-sg
