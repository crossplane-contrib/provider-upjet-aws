# RBAC required for provider to create ServiceAccount tokens
# This ClusterRole and ClusterRoleBinding must be created to allow
# the provider to request tokens from ServiceAccounts
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: provider-aws-serviceaccount-token-creator
  labels:
    app.kubernetes.io/name: provider-aws
    app.kubernetes.io/component: rbac
rules:
  - apiGroups: [""]
    resources: ["serviceaccounts/token"]
    verbs: ["create"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: provider-aws-serviceaccount-token-creator
  labels:
    app.kubernetes.io/name: provider-aws
    app.kubernetes.io/component: rbac
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: provider-aws-serviceaccount-token-creator
subjects:
  # Replace with your actual provider ServiceAccount name and namespace
  # You can find this by running:
  # kubectl get pods -n upbound-system -o jsonpath='{.items[*].spec.serviceAccountName}' | grep provider-aws
  - kind: ServiceAccount
    name: provider-aws-abcdef123456  # Replace with actual provider ServiceAccount name
    namespace: upbound-system         # Replace with actual provider namespace
---
# Example: Multi-tenant setup with ServiceAccount per namespace
# Create this in each tenant namespace
apiVersion: v1
kind: ServiceAccount
metadata:
  name: tenant-irsa-sa
  namespace: tenant-namespace  # Replace with actual tenant namespace
  annotations:
    # This IAM role must have a trust policy that allows the ServiceAccount to assume it
    # Trust policy should include: sts.amazonaws.com with condition on
    # the ServiceAccount's namespace and name
    eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/tenant-role
---
# IAM Trust Policy example (in AWS) for the role referenced above:
# {
#   "Version": "2012-10-17",
#   "Statement": [
#     {
#       "Effect": "Allow",
#       "Principal": {
#         "Federated": "arn:aws:iam::ACCOUNT_ID:oidc-provider/oidc.eks.REGION.amazonaws.com/id/CLUSTER_ID"
#       },
#       "Action": "sts:AssumeRoleWithWebIdentity",
#       "Condition": {
#         "StringEquals": {
#           "oidc.eks.REGION.amazonaws.com/id/CLUSTER_ID:sub": "system:serviceaccount:tenant-namespace:tenant-irsa-sa",
#           "oidc.eks.REGION.amazonaws.com/id/CLUSTER_ID:aud": "sts.amazonaws.com"
#         }
#       }
#     }
#   ]
# }
