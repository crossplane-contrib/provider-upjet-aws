# ValidatingAdmissionPolicy to enforce ServiceAccount as the only allowed credential source
# This is an OPTIONAL policy that cluster administrators can deploy to restrict
# authentication methods to ServiceAccount only.
#
# Prerequisites:
# - Kubernetes 1.30+ (ValidatingAdmissionPolicy is GA)
#
# To deploy:
#   kubectl apply -f enforce-serviceaccount-only.yaml
#
# To remove enforcement:
#   kubectl delete -f enforce-serviceaccount-only.yaml
---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionPolicy
metadata:
  name: enforce-serviceaccount-only
spec:
  failurePolicy: Fail
  matchConstraints:
    resourceRules:
    - apiGroups: ["aws.upbound.io", "aws.m.upbound.io"]
      apiVersions: ["v1beta1"]
      operations: ["CREATE", "UPDATE"]
      resources: ["providerconfigs", "clusterproviderconfigs"]
  validations:
  - expression: "object.spec.credentials.source == 'ServiceAccount'"
    message: "Only 'ServiceAccount' credential source is allowed. Other sources (IRSA, WebIdentity, Secret, etc.) are blocked by policy."
    reason: Forbidden
---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionPolicyBinding
metadata:
  name: enforce-serviceaccount-only-binding
spec:
  policyName: enforce-serviceaccount-only
  validationActions: [Deny]
  # Optional: Use matchConditions to scope the policy further
  # For example, only enforce in specific namespaces for ProviderConfigs:
  # matchConditions:
  # - name: namespace-filter
  #   expression: "!has(object.metadata.namespace) || object.metadata.namespace in ['prod', 'staging']"
